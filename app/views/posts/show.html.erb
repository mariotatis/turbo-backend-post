<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.js" defer></script>

<% if notice.present? %>
  <p style="color: green" data-controller="bridge--flash-message"><%= notice %></p>
<% end %>

<article class="rounded-lg border border-gray-100 p-4 mb-5 shadow-[rgba(7,_65,_210,_0.1)_0px_9px_30px]">

  <%= render partial: 'post_body', locals: { post: @post } %>
  <%= render partial: 'post_actions', locals: { post: @post } %>

  <% unless @post.post_url.empty? %>
    <hr class='m-4'/>
    <p>
      <a href="<%= @post.post_url %>" target="_blank" class="text-sm underline">
        <%= truncate(@post.post_url, length: 40, omission: '...') %>
      </a>
    </p>

    <div id="pageData" data-controller="post" data-id="<%= @post.id %>">
      <p class='text-xs'>Loading...<p>
    </div>

  <% end %>
  
</article>

<article class="rounded-lg border border-gray-100 p-4 mb-5 shadow-[rgba(7,_65,_210,_0.1)_0px_9px_30px]">

  <h3 class="mt-0.5 mb-5 text-l font-semibold text-slate-900">
    <i class="fa-regular fa-comment text-sky-900"></i> <%= pluralize(@post.comments_counter, 'Comment') %>
  </h3>

  <% if @post.comments_counter > 0%>
    <div class="mb-8">
      <% @post.comments.each do |comment| %>
        <article class="text-base  border-b border-gray-200 bg-white rounded-lg mb-4">
          <footer class="flex justify-between items-center">
            <div class="flex items-center">
              <p class="text-xs text-gray-600"><time pubdate datetime="2022-02-08"
                title="February 8th, 2022"><%= time_ago_in_words(comment.created_at) %> ago</time>
              </p>
            </div>
            <% if comment.user == current_user %>
              <%= link_to post_comment_path(@post, comment), method: :delete,
                  class: "inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 bg-white rounded-lg focus:ring-4 focus:outline-none focus:ring-gray-50",
                  data: { turbo_confirm: "Are you sure you want to remove this comment?", "turbo-method": :delete } do %>
                  <i class="fa-regular fa-trash-can"></i>
                <% end %>
            <% end %>
          </footer>
          <p class="text-gray-500 mb-4"><%= comment.comment%></p>
        </article>
      <% end %>
    </div>
  <% end %>

  <%= form_with(model: [@post, Comment.new], local: true) do |form| %>
    <div class='flex flex-col relative w-full rounded-lg overflow-hidden mx-auto' x-data="{maximum: ''}">
        <%= form.text_area :comment, rows: 2, class: "h-auto min-h-[80px] w-full rounded-lg border-gray-200 p-4 h-16 text-sm shadow-sm", placeholder: "Add a new comment", "x-data" => "{ resize () { $el.style.height = '0px'; $el.style.height = $el.scrollHeight + 'px' } }", "x-init" => "resize()", "@input" => "resize()" %>
    </div>

    <%= form.hidden_field :user_id, value: current_user.id %>
    <div class="flex items-center justify-between mt-4">      
        <%= form.submit 'Add Comment', class: 'float-right block rounded-lg bg-sky-500 px-5 py-3 text-sm font-medium text-white' %>
      </div>
  <% end %>
    
</article>

<%= link_to "Edit Post", edit_post_path(@post), class: "hide-on-mobile mt-1 pl-4 text-sm", data: { controller: "bridge--nav-button", bridge_title: "Edit" } %>
<%= link_to 'Destroy this post', @post, "data-turbo-method": :delete, method: :delete, class: "mt-1 pl-4 text-sm", data: { turbo_confirm: 'Are you sure you want to delete this post?' } %>